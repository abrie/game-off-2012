<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>test</title>

	<link href="styles.css" rel="stylesheet" type="text/css" />
	<script>
		var createjs = window;
	</script>
	<script type="text/javascript" src="lib/easeljs-0.5.0.min.js"></script>
	<script type="text/javascript" src="lib/underscore-min.js"></script>

	<script>
	var FOOT1 = 1, FOOT2 = 2, FOOT3 = 3, FOOT4 = 4;
	var keyMap = {76:FOOT1, 75:FOOT2, 74:FOOT3, 72:FOOT4};

	var intentionSequence = [];
	function newIntentionSequence() {
		intentionSequence.length = 0;
	}

	var currentIntention = [];
	function newIntention() {
		intentionSequence.push(currentIntention);
		currentIntention = [];
		console.log("newIntention:");
		_.each( intentionSequence, function(v) { console.log(v); } );
		console.log("---");
		
	}

	function addIntentionToSequence() {
		if (currentIntention.length > 0) {
			newIntention();
		}
	}

	function mostRecentIntention() {
		if (currentIntention.length >= 1 ) {
			return currentIntention;
		}
		else if (intentionSequence.length >= 1) {
			return intentionSequence[ intentionSequence.length-1 ];
		}
		else {
			return undefined;
		}
	}

	var ACTION_STEP_FORWARD = 1;
	var ACTION_NOTHING = 0;
	function evaluateIntentionSequence() {
		var lastIntention = mostRecentIntention();
		var result = ACTION_NOTHING;
		if(lastIntention) {
			if (_.contains(lastIntention, FOOT3)) {
				if(intentionSequence.length == 3) { // all the steps are on seperate frames
					if( _.contains(intentionSequence[0], FOOT1) &&
						_.contains(intentionSequence[1], FOOT2) &&
						_.contains(intentionSequence[2], FOOT3)) 
						result = ACTION_STEP_FORWARD;
					newIntentionSequence();
				}
			}
			else if(_.contains(lastIntention, FOOT1)) {
				if(intentionSequence.length > 1) {
					newIntentionSequence();
					currentIntention.push(FOOT1);
				}
			}
		}
		return result;
	}

	function onKeyDown(keyCode) {
		var mapped = keyMap[keyCode];
		if (mapped) {
			currentIntention.push(mapped);
			return false;
		}
	}

	function handleKeyDown(e) {
		//cross browser issues exist, says EaselJS
		if(!e){ var e = window.event; }
		return onKeyDown(e.keyCode);
	}

	function handleKeyUp(e) {
		return;
	}

	var playerImage = undefined;
	var player = {pX:100,pY:100,vX:0,vY:0}
	function initPlayer() {
		playerImage = new Shape();
		playerImage.graphics.beginFill("red").drawCircle(0, 0, 10);
		playerImage.x = 100;
		playerImage.y = 100;
		stage.addChild(playerImage);
	}

	var stage = undefined;
	function init() {
		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;
		var canvas = document.getElementById("testCanvas");

		stage = new Stage(canvas);
		initPlayer();

		stage.update();
		Ticker.setFPS(30);
		Ticker.useRAF = true;
		Ticker.addListener(window);
	}

	function tick(elapsedTime) {
		addIntentionToSequence();
		var nextAction = evaluateIntentionSequence();
		if( nextAction != ACTION_NOTHING )
		{
			console.log("action:",nextAction);
			if( nextAction === ACTION_STEP_FORWARD ) {
				playerImage.x = playerImage.x + 10;
				playerImage.y = playerImage.y;
			}
		}
		if (playerImage.x > stage.canvas.width) { playerImage.x = 0; }
		stage.update();
		
	}
	</script>
</head>
	
<body onload="init();">

	<header id="header" class="EaselJS">
		just playin'
	</header>

	<div class="canvasHolder">
		<canvas id="testCanvas" width="960" height="400"></canvas>
	</div>
</body>
</html>
