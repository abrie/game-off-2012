<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>test</title>

	<link href="styles.css" rel="stylesheet" type="text/css" />
	<script>
		var createjs = window;
	</script>
	<script type="text/javascript" src="lib/easeljs-0.5.0.min.js"></script>
	<script type="text/javascript" src="lib/underscore-min.js"></script>

	<script>
	var KEYCODE_step1 = 76;
	var KEYCODE_step2 = 75
	var KEYCODE_step3 = 74;
	var KEYCODE_step4 = 72;
	var KEYCODE_SPACE = 32;

	var checkImpel = false;
	function handleKeyDown(e) {
		//cross browser issues exist, says EaselJS
		if(!e){ var e = window.event; }
		switch(e.keyCode) {
			case KEYCODE_step1: storekey(1); return false;
			case KEYCODE_step2: storekey(2); return false; 
			case KEYCODE_step3: storekey(3); return false; 
			case KEYCODE_step4: storekey(4); checkImpel = true; return false; 
			case KEYCODE_SPACE:	turnClockwise(); return false;
		}
	}

	function handleKeyUp(e) {
		return;

		//cross browser issues exist, says EaselJS
		if(!e){ var e = window.event; }
		switch(e.keyCode) {
			case KEYCODE_step1: removekey(1); return false;
			case KEYCODE_step2: removekey(2); return false; 
			case KEYCODE_step3: removekey(3); return false; 
			case KEYCODE_step4: removekey(4); return false; 
			case KEYCODE_SPACE:	turnClockwise(); return false;
		}
	}

	var keyTimes = {};
	var walk = 0;
	function storekey(v) {
		keyTimes[v] = +new Date;
	}

	function removekey(v) {
		delete keyTimes[v];
	}

	function clearImpel() {
		delete keyTimes[1];
		delete keyTimes[2];
		delete keyTimes[3];
		delete keyTimes[4];
	}

	function shouldImpel() {
		if( keyTimes[1] < keyTimes[2] &&
			keyTimes[2] < keyTimes[3] &&
			keyTimes[3] < keyTimes[4] )
		{
			return true;
		}
		else
		{
			return false;
		}
	}

	var playerImage = undefined;
	var player = {pX:100,pY:100,vX:0,vY:0}
	function initPlayer() {
		playerImage = new Shape();
		playerImage.graphics.beginFill("red").drawCircle(0, 0, 10);
		playerImage.x = 100;
		playerImage.y = 100;
		stage.addChild(playerImage);
	}

	function impelPlayer(val) {
		switch(dir) {
			case 0: player.vX=val*1; break;
			case 1: player.vY=val*1; break;
			case 2: player.vX=val*-1; break;
			case 3: player.vY=val*-1; break;
		}
	}

	var dir = 0;
	function turnClockwise() {
		dir = dir >= 3 ? 0 : dir+1;
	}

	var stage = undefined;
	function init() {
		document.onkeydown = handleKeyDown;
		document.onkeyup = handleKeyUp;
		var canvas = document.getElementById("testCanvas");

		stage = new Stage(canvas);
		initPlayer();

		stage.update();
		Ticker.setFPS(20);
		Ticker.useRAF = true;
		Ticker.addListener(window);
	}

	function tickPlayer(elapsedTime) {
		if( player.vX > 0 ) {
			player.vX-=1;
		}
		if( player.vX < 0 ) {
			player.vX+=1;
		}
		if( player.vY > 0 ) {
			player.vY-=1;
		}
		if( player.vY < 0 ) {
			player.vY+=1;
		}
	}

	function tick(elapsedTime) {
		// time based
		if (checkImpel) {
				if (shouldImpel()) 
				{
					impelPlayer(12);
				} 
				checkImpel = false;
				clearImpel();
		}
		playerImage.x = playerImage.x + Math.ceil( player.vX*elapsedTime/1000*10 );
		playerImage.y = playerImage.y + Math.ceil( player.vY*elapsedTime/1000*10 );
		if (playerImage.x > stage.canvas.width) { playerImage.x = 0; }
		tickPlayer(elapsedTime);
		stage.update();
	}
	</script>
</head>
	
<body onload="init();">

	<header id="header" class="EaselJS">
		just playin'
	</header>

	<div class="canvasHolder">
		<canvas id="testCanvas" width="960" height="400"></canvas>
	</div>
</body>
</html>
